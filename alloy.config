 // pgo metrics
discovery.kubernetes "pgo_metrics_pods" {
  role = "pod" // matches kubernetes_sd_configs role: pod
  selectors {
    role  = "pod"
    label = "postgres-operator.crunchydata.com/control-plane"
  }
}

prometheus.relabel "pgo_metrics_targets" {
  targets = discovery.kubernetes.pgo_metrics_pods.targets

  // No port filtering here; the operator exposes 8080/https with self-signed by default per note.
  // Keep everything discovered; additional filtering can be added if needed.
  
  forward_to = [prometheus.scrape.pgo_metrics.receiver]
}

prometheus.scrape "pgo_metrics" {
  targets = prometheus.relabel.pgo_metrics_targets.output

  job_name        = "pgo-metrics"
  scheme          = "https"
  scrape_interval = "15s"
  scrape_timeout  = "15s"

  authorization {
    type              = "Bearer"
    credentials_file  = "/var/run/secrets/kubernetes.io/serviceaccount/token"
  }

  tls_config {
    insecure_skip_verify = true
  }

  // Forward to the local Prometheus-compatible writer or remote write as needed.
  // Replace with the appropriate receiver(s) in the deployment.
  // Example: forward_to = [prometheus.remote_write.default.receiver]
}

// crunchy-postgres-exporter

discovery.kubernetes "crunchy_pgexp_pods" {
  role = "pod"
  selectors {
    role  = "pod"
    label = "postgres-operator.crunchydata.com/crunchy-postgres-exporter=true"
  }
}

prometheus.relabel "crunchy_pgexp_targets" {
  targets = discovery.kubernetes.crunchy_pgexp_pods.targets

  // Keep only container port 9187
  rule {
    action        = "keep"
    source_labels = ["__meta_kubernetes_pod_container_port_number"]
    regex         = "9187"
  }

  // kubernetes_namespace label
  rule {
    source_labels = ["__meta_kubernetes_namespace"]
    target_label  = "kubernetes_namespace"
  }

  // pod label
  rule {
    source_labels = ["__meta_kubernetes_pod_name"]
    target_label  = "pod"
  }

  // pg_cluster = namespace:cluster
  rule {
    source_labels = ["__meta_kubernetes_namespace","__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_cluster"]
    target_label  = "pg_cluster"
    separator     = ":"
    replacement   = "$1$2"
  }

  // ip = pod IP
  rule {
    source_labels = ["__meta_kubernetes_pod_ip"]
    target_label  = "ip"
  }

  // deployment from instance label
  rule {
    source_labels = ["__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_instance"]
    target_label  = "deployment"
  }

  // role
  rule {
    source_labels = ["__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_role"]
    target_label  = "role"
  }

  forward_to = [prometheus.scrape.crunchy_pgexp.receiver]
}

prometheus.scrape "crunchy_pgexp" {
  targets         = prometheus.relabel.crunchy_pgexp_targets.output
  job_name        = "crunchy-postgres-exporter"
  scrape_interval = "15s"
  scrape_timeout  = "15s"

  // Example forward; adjust to match the Helm chartâ€™s pipeline.
  // forward_to = [prometheus.remote_write.default.receiver]
}

// crunchy-otel-collector
discovery.kubernetes "crunchy_otel_pods" {
  role = "pod"
  selectors {
    role  = "pod"
    label = "postgres-operator.crunchydata.com/crunchy-otel-collector=true"
  }
}

prometheus.relabel "crunchy_otel_targets" {
  targets = discovery.kubernetes.crunchy_otel_pods.targets

  // Keep only container port 9187
  rule {
    action        = "keep"
    source_labels = ["__meta_kubernetes_pod_container_port_number"]
    regex         = "9187"
  }

  // kubernetes_namespace label
  rule {
    source_labels = ["__meta_kubernetes_namespace"]
    target_label  = "kubernetes_namespace"
  }

  // pod label
  rule {
    source_labels = ["__meta_kubernetes_pod_name"]
    target_label  = "pod"
  }

  // pg_cluster = namespace:cluster
  rule {
    source_labels = ["__meta_kubernetes_namespace","__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_cluster"]
    target_label  = "pg_cluster"
    separator     = ":"
    replacement   = "$1$2"
  }

  // ip label
  rule {
    source_labels = ["__meta_kubernetes_pod_ip"]
    target_label  = "ip"
  }

  // deployment from instance label
  rule {
    source_labels = ["__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_instance"]
    target_label  = "deployment"
  }

  // role
  rule {
    source_labels = ["__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_role"]
    target_label  = "role"
  }

  // pgMonitor helper labels
  rule {
    source_labels = ["__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_role"]
    target_label  = "exp_type"
  }

  rule {
    source_labels = ["__meta_kubernetes_namespace","__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_cluster"]
    target_label  = "cluster_name"
    separator     = ":"
    replacement   = "$1$2"
  }

  forward_to = [prometheus.scrape.crunchy_otel.receiver]
}

prometheus.scrape "crunchy_otel" {
  targets         = prometheus.relabel.crunchy_otel_targets.output
  job_name        = "crunchy-otel-collector"
  scrape_interval = "15s"
  scrape_timeout  = "15s"

  // forward_to = [prometheus.remote_write.default.receiver]
}
